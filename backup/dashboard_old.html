<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Metrics Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4">

<div class="max-w-5xl mx-auto space-y-6">

  <!-- Control Card -->
  <div class="bg-white rounded-xl shadow-md p-6 text-center space-y-4">
    <h2 class="text-xl font-semibold text-gray-800">Control Metrics</h2>
    <div class="flex justify-center space-x-4">
      <button id="start-btn" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Start</button>
      <button id="stop-btn" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Stop</button>
    </div>
    <div id="control-response" class="text-gray-700 font-medium"></div>
  </div>

  <!-- Settings Card -->
  <div class="bg-white rounded-xl shadow-md p-6 space-y-4">
    <h2 class="text-xl font-semibold text-gray-800 text-center">Settings</h2>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">

      <div>
        <label class="block text-sm font-medium text-gray-600">Speed Wheel Circumference (m)</label>
        <input type="number" step="0.001" min="0" id="speed-wheel"
               class="border rounded px-2 py-1 w-full">
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-600">Distance Wheel Circumference (m)</label>
        <input type="number" step="0.001" min="0" id="distance-wheel"
               class="border rounded px-2 py-1 w-full">
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-600">Age</label>
        <input type="number" min="1" id="age"
               class="border rounded px-2 py-1 w-full">
      </div>

    </div>

    <div class="text-center">
      <button id="settings-btn"
              class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
        Update Settings
      </button>
    </div>

    <div id="settings-response" class="text-gray-700 font-medium text-center"></div>
  </div>

  <!-- Live Metrics Card -->
  <div class="bg-white rounded-xl shadow-md p-6">
    <h1 class="text-2xl font-bold text-gray-800 mb-4 text-center">Live Metrics</h1>

    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm">

      <div class="flex justify-between"><span>Power:</span><span id="power">—</span></div>
      <div class="flex justify-between"><span>Speed:</span><span id="speed">—</span></div>
      <div class="flex justify-between"><span>Cadence:</span><span id="cadence">—</span></div>
      <div class="flex justify-between"><span>Distance:</span><span id="distance">—</span></div>
      <div class="flex justify-between"><span>Heart Rate:</span><span id="heart_rate">—</span></div>
      <div class="flex justify-between"><span>HR %:</span><span id="heart_rate_percent">—</span></div>
      <div class="flex justify-between"><span>Zone:</span><span id="zone">—</span></div>
      <div class="flex justify-between"><span>Running:</span><span id="is_running">—</span></div>

    </div>
  </div>

  <!-- Devices Card -->
  <div class="bg-white rounded-xl shadow-md p-6">
    <h2 class="text-xl font-semibold text-gray-800 mb-4 text-center">Connected Devices</h2>
    <ul class="divide-y divide-gray-200" id="devices-list"></ul>
  </div>

</div>

<script>
/* ---------------------------
   Load Current Settings
---------------------------- */
async function loadSettings() {
  try {
    const res = await fetch("/metrics/settings");
    const data = await res.json();

    document.getElementById("speed-wheel").value =
      data.speed_wheel_circumference_m ?? "";

    document.getElementById("distance-wheel").value =
      data.distance_wheel_circumference_m ?? "";

    document.getElementById("age").value =
      data.age ?? "";
  } catch (err) {
    console.error("Failed to load settings:", err);
  }
}
loadSettings();

/* ---------------------------
   Update Settings
---------------------------- */
document.getElementById("settings-btn").addEventListener("click", async () => {
  const payload = {
    speed_wheel_circumference_m:
      parseFloat(document.getElementById("speed-wheel").value) || null,

    distance_wheel_circumference_m:
      parseFloat(document.getElementById("distance-wheel").value) || null,

    age:
      parseInt(document.getElementById("age").value) || null
  };

  try {
    const res = await fetch("/metrics/settings", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    document.getElementById("settings-response").textContent =
      data.message ?? "Settings updated";
  } catch (err) {
    document.getElementById("settings-response").textContent =
      "Error updating settings";
  }
});

/* ---------------------------
   Start / Stop
---------------------------- */
async function postControl(endpoint) {
  try {
    const res = await fetch(endpoint, { method: "POST" });
    const data = await res.json();
    document.getElementById("control-response").textContent =
      data.message ?? "Done";
  } catch (err) {
    document.getElementById("control-response").textContent = "Error";
  }
}
document.getElementById("start-btn")
  .addEventListener("click", () => postControl("/metrics/start"));

document.getElementById("stop-btn")
  .addEventListener("click", () => postControl("/metrics/stop"));

/* ---------------------------
   Metrics SSE
---------------------------- */
const metricsSource = new EventSource("/metrics/stream");

metricsSource.onmessage = function(event) {
  const data = JSON.parse(event.data);

  document.getElementById("power").textContent =
    data.power ?? "—";

  document.getElementById("speed").textContent =
    data.speed ?? "—";

  document.getElementById("cadence").textContent =
    data.cadence ?? "—";

  document.getElementById("distance").textContent =
    data.distance ?? "—";

  document.getElementById("heart_rate").textContent =
    data.heart_rate ?? "—";

  document.getElementById("heart_rate_percent").textContent =
    data.heart_rate_percent
      ? data.heart_rate_percent.toFixed(1) + " %"
      : "—";

  document.getElementById("zone").textContent =
    data.zone ?? "Unknown";

  document.getElementById("is_running").textContent =
    data.is_running ? "Yes" : "No";
};

/* ---------------------------
   Devices SSE
---------------------------- */
const devicesSource = new EventSource("/metrics/devices/stream");

devicesSource.onmessage = function(event) {
  const devices = JSON.parse(event.data);
  const list = document.getElementById("devices-list");
  list.innerHTML = "";

  devices.forEach(dev => {
    const li = document.createElement("li");
    li.className = "py-2 flex justify-between text-sm";
    li.innerHTML = `
      <span class="font-medium">${dev.name}</span>
      <span>ID: ${dev.device_id} | Type: ${dev.device_type}</span>
    `;
    list.appendChild(li);
  });
};
</script>

</body>
</html>